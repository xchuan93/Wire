# Wire
当用户第一次使用应用程序进行身份验证时，应用程序会生成密钥信息并将一定数量的预密钥上传到后端。

当一个设备以端到端的加密方式与另一个设备通信时，他们都必须知道以其他人无法解密它们的方式加密消息的方式。要与已知设备X建立会话，必须首先从后端获取初始密钥（prekey），然后使用此密钥启动会话。启动会话时，可以从其状态推断消息密钥。加密消息会更改会话。

每条消息都有新密钥。如果消息仅在一个方向上发送，则使用HKDH（散列）密钥派生函数创建的密钥对每个下一个消息进行加密。但是，对于每个消息，密钥被发送以使用Diffie-Hellman过程重置加密会话。这更安全，因为攻击者无法从先前的密钥推断出此密钥。

我们假设我们有用户A和B，他们有自己的设备，比如A_d，A_m和B_d，B_m。当A_d想要将消息发送到与B的会话时，它必须与A_m，B_d和B_m进行持续的加密会话。进行会话后，设备将使用其会话为每个接收者加密消息，并将密文发送到有线后端。

所有文件（图像，音频，视频，文档）都以相同的方式上传。要上传文件或更大的消息，我们正在执行以下步骤：

将文件存储到缓存中。
为AES128对称加密生成安全随机密钥，并使用密钥K和验证签名HMAC加密文件。
将加密文件上传到后端并接收其资产ID。
将端到端加密消息发送到对话中包含资产ID，对称解密密钥K和HMAC值的所有接收方的所有设备。
